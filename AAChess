local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

-- Cache player objects
local player = Players.LocalPlayer
local pGui = player:WaitForChild("PlayerGui")

-- Game Objects (cached)
local ServerInfo = ReplicatedStorage:WaitForChild("Server Information")
local WaveValue = ServerInfo:WaitForChild("Wave")
local Remotes = ReplicatedStorage:WaitForChild("Remotes")
local UpboardRemote = Remotes.Upboard
local ChampionRemote = Remotes:WaitForChild("Champion")
local XmasRemote = Remotes:FindFirstChild("GameModes") and Remotes.GameModes:FindFirstChild("XMasDifficulties")
local NotifyRemote = Remotes:WaitForChild("Notify")
local PossessionRemote = Remotes:WaitForChild("Possession")
local SettingsRemote = Remotes:WaitForChild("Settings")
local AwardRemote = Remotes:WaitForChild("Award")

local LobbyRelatives = ReplicatedStorage:FindFirstChild("Lobby Relatives")
local DoorsRemote = LobbyRelatives and LobbyRelatives:FindFirstChild("Doors")
local ChristmasMapRemote = LobbyRelatives and LobbyRelatives:FindFirstChild("ChristmasMap")
local LimitlessRemote = LobbyRelatives and LobbyRelatives:FindFirstChild("Limitless")
local ChristmasShopRemote = LobbyRelatives and LobbyRelatives:FindFirstChild("ChristmasShop")
local InventoryRemote = Remotes:FindFirstChild("Inventory")

-- State
local aggressiveSpam = false
local currentWaveNum = 0
local giftCount, candyCount = 0, 0
local isCollectingItems = false 
local centerPoint = nil
local angle = 0
local challengeRunning = false
local challengeAttempts = 0
local isInChristmasEvent = false
local isInInfiniteMode = false
local candyCapacityReached = false
local bagUsageStopped = false

-- Constants
local LOBBY_PLACEID = 16695366828
local CHALLENGE_ROOMS = {"Hourly_01_01", "Hourly_01_02", "Hourly_02_01", "Hourly_02_02", "Hourly_03_01", "Hourly_03_02"}
local TP_POS = Vector3.new(78.55, 4.08, -217.50)
local XMAS_POS = Vector3.new(-81.45, 3.94, -22.50)
local INFINITE_POS = Vector3.new(-177.96, 30.14, 41.08)

-- NEW: Bag system variables
local activeBagIds = {} -- Store both working bag IDs
local bagCheckInProgress = false
local scanningComplete = false

-- NEW: Ticket buying variables
local ticketBuyDetected = false
local noCurrency = false
local purchasedTicketId = nil  -- Store the ticket ID from successful purchase

-- UI Window
local Window = Fluent:CreateWindow({
    Title = "Aden Hub (AAC)",
    SubTitle = "v138 - Dev Detection",
    TabWidth = 140,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = false,
    Theme = "Dark"
})

local Tabs = {
    Main = Window:AddTab({ Title = "Main", Icon = "play" }),
    Ability = Window:AddTab({ Title = "Auto Ability", Icon = "zap" }), 
    AutoJoin = Window:AddTab({ Title = "Auto Join", Icon = "door-open" }),
    Dodge = Window:AddTab({ Title = "Dodge", Icon = "move" }),
    Items = Window:AddTab({ Title = "Items", Icon = "package" }),
    Webhook = Window:AddTab({ Title = "Webhook", Icon = "send" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- Main Tab
Tabs.Main:AddSection("Statistics")
local dataPara = Tabs.Main:AddParagraph({Title = "Items Collected", Content = "Gifts: 0 | Candy: 0"})

Tabs.Main:AddSection("Automation")
Tabs.Main:AddToggle("AutoCollect", {Title = "Auto Collect", Default = false})
Tabs.Main:AddToggle("AutoRetry", {Title = "Auto Retry Match", Default = false})
Tabs.Main:AddToggle("AutoSkip", {Title = "Auto Skip Waves", Default = false})
Tabs.Main:AddDropdown("AutoDifficulty", {Title = "Difficulty", Values = {"None", "Easy", "Normal", "Hard", "Extreme"}, Default = "None"})

-- Ability Tab
Tabs.Ability:AddSection("Awakening")
Tabs.Ability:AddToggle("AutoAwaken", {Title = "Auto Awaken", Default = false})
Tabs.Ability:AddInput("StartWaveInput", {Title = "Start Wave", Default = "20", Numeric = true})
local statusPara = Tabs.Ability:AddParagraph({Title = "Status", Content = "Wave: 0 | Ready: NO"})

-- Auto Join Tab
Tabs.AutoJoin:AddSection("Challenge Automation")
local JoinChallenge = Tabs.AutoJoin:AddToggle("AutoJoinChallenge", {Title = "Auto Join Challenge", Default = false})
Tabs.AutoJoin:AddDropdown("SelectItem", {
    Title = "Select Target Item", 
    Values = {"C_A_A_Power Fragment", "C_C_C_Devil Soul", "C_A_A_Deluxe Dice", "C_A_A_Dice"}, 
    Default = "C_A_A_Power Fragment"
})
local challengeStatus = Tabs.AutoJoin:AddParagraph({Title = "Challenge Status", Content = "Awaiting Setup..."})

Tabs.AutoJoin:AddSection("Join Christmas Event")
Tabs.AutoJoin:AddToggle("JoinChristmasEvent", {Title = "Join Christmas Event", Default = false})
Tabs.AutoJoin:AddToggle("JoinEventNoItem", {Title = "Join Event if No Item Found", Default = false})
local eventStatus = Tabs.AutoJoin:AddParagraph({Title = "Event Status", Content = "Waiting..."})

Tabs.AutoJoin:AddSection("Auto Join Infinite")
Tabs.AutoJoin:AddToggle("AutoJoinInfinite", {Title = "Auto Join Infinite if No Item", Default = false})
local infiniteStatus = Tabs.AutoJoin:AddParagraph({Title = "Infinite Status", Content = "Waiting..."})

-- NEW: Winter Ticket Section
Tabs.AutoJoin:AddSection("Winter Ticket Automation")
Tabs.AutoJoin:AddToggle("UseWinterTicket", {Title = "Auto Use Purchased Winter Ticket", Default = false})
local winterTicketStatus = Tabs.AutoJoin:AddParagraph({Title = "Winter Ticket Status", Content = "Waiting..."})

Tabs.AutoJoin:AddSection("Priority System (After 3 Failed Attempts)")
Tabs.AutoJoin:AddDropdown("Priority1", {
    Title = "1st Priority", 
    Values = {"None", "Winter Ticket", "Infinite Mode", "Christmas Event"}, 
    Default = "Winter Ticket"
})
Tabs.AutoJoin:AddDropdown("Priority2", {
    Title = "2nd Priority", 
    Values = {"None", "Winter Ticket", "Infinite Mode", "Christmas Event"}, 
    Default = "Infinite Mode"
})
Tabs.AutoJoin:AddDropdown("Priority3", {
    Title = "3rd Priority", 
    Values = {"None", "Winter Ticket", "Infinite Mode", "Christmas Event"}, 
    Default = "Christmas Event"
})

Tabs.AutoJoin:AddSection("Auto Teleport Timer")
local timeStatus = Tabs.AutoJoin:AddParagraph({Title = "Time Status", Content = "Monitoring disabled"})

Tabs.AutoJoin:AddSection("Developer Detection")
Tabs.AutoJoin:AddToggle("AutoServerHop", {Title = "Auto Server Hop if Dev Found", Default = false})
local devStatus = Tabs.AutoJoin:AddParagraph({Title = "Dev Status", Content = "Scanning disabled"})

-- Dodge Tab
Tabs.Dodge:AddSection("Spin Dodge")
Tabs.Dodge:AddToggle("EnableSpin", {Title = "Spin Dodge", Default = false})
Tabs.Dodge:AddInput("SpinRadius", {Title = "Radius", Default = "10", Numeric = true})
Tabs.Dodge:AddInput("SpinSpeed", {Title = "Speed", Default = "5", Numeric = true})

Tabs.Dodge:AddSection("Anti-AFK")
Tabs.Dodge:AddToggle("AntiAFK", {Title = "Anti-AFK", Default = true})
local afkStatus = Tabs.Dodge:AddParagraph({Title = "AFK Status", Content = "Anti-AFK: Enabled"})

-- Items Tab
Tabs.Items:AddSection("Bag Opener")
Tabs.Items:AddToggle("UseAllBags", {Title = "Use All Bags", Default = false})
Tabs.Items:AddInput("BagScanStart", {Title = "Bag Scan Start ID", Default = "120", Numeric = true, Placeholder = "Start ID"})
Tabs.Items:AddInput("BagScanEnd", {Title = "Bag Scan End ID", Default = "150", Numeric = true, Placeholder = "End ID"})
local bagStatus = Tabs.Items:AddParagraph({Title = "Bag Status", Content = "Disabled"})

Tabs.Items:AddSection("Ticket Buyer (Buy with Currency)")
Tabs.Items:AddToggle("AutoBuyTicket", {Title = "Auto Buy Ticket", Default = false})
local ticketStatus = Tabs.Items:AddParagraph({Title = "Ticket Status", Content = "Disabled"})

-- Webhook Tab
Tabs.Webhook:AddSection("Discord Webhook")
Tabs.Webhook:AddInput("WebhookURL", {Title = "Enter Webhook", Default = ""})
Tabs.Webhook:AddToggle("EnableWebhook", {Title = "Enable Webhook", Default = false})
local webhookStatus = Tabs.Webhook:AddParagraph({Title = "Status", Content = "Webhook not configured"})

--- LOGIC ---

local function sendWebhook(url, data)
    local success, response = pcall(function()
        local http_func = syn and syn.request or http and http.request or http_request or request
        if not http_func then return nil end
        return http_func({
            Url = url,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode(data)
        })
    end)
    return success and response and (not response.StatusCode or (response.StatusCode >= 200 and response.StatusCode < 300))
end

local function formatRewards(scrollingFrame)
    local rewards = {}
    for _, child in pairs(scrollingFrame:GetChildren()) do
        if child:IsA("GuiObject") and not child:IsA("UIListLayout") and not child:IsA("UIPadding") and not child:IsA("UIGridLayout") then
            if child.Name:match("^B_") then
                local cleanName = child.Name:gsub("^B_[A-Z]_[A-Z]_", ""):gsub("_", " ")
                if cleanName ~= "" then table.insert(rewards, "‚Ä¢ " .. cleanName) end
            end
        end
    end
    return #rewards > 0 and table.concat(rewards, "\n") or "No rewards"
end

local function testWebhook()
    local url = Fluent.Options.WebhookURL.Value
    if not url or url == "" then webhookStatus:SetDesc("‚ùå Enter webhook URL"); return end
    if not url:match("^https://discord") then webhookStatus:SetDesc("‚ùå Invalid URL"); return end
    
    webhookStatus:SetDesc("‚è≥ Sending...")
    local success = sendWebhook(url, {
        username = "Aden Hub",
        embeds = {{
            title = "‚úÖ Webhook Test",
            description = "Working correctly!",
            color = 65280,
            timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
        }}
    })
    task.wait(0.5)
    webhookStatus:SetDesc(success and "‚úÖ Test sent!" or "‚ùå Failed")
end

Tabs.Webhook:AddButton({Title = "Test Webhook", Description = "Send test message", Callback = testWebhook})

-- Developer Detection (Optimized)
local DEV_IMAGE_PATTERNS = {"hammer", "admin", "developer"}

local function checkForDevelopers()
    for _, plr in pairs(Players:GetPlayers()) do
        if plr == player then continue end -- Skip self
        
        local plrGui = plr:FindFirstChild("PlayerGui")
        if plrGui then
            local overheadGui = plrGui:FindFirstChild("OverheadGui") or plrGui:FindFirstChild("Overhead") or plrGui:FindFirstChild("DeveloperGui")
            if overheadGui then
                for _, desc in pairs(overheadGui:GetDescendants()) do
                    if desc:IsA("ImageLabel") or desc:IsA("ImageButton") then
                        local img = desc.Image:lower()
                        for _, pattern in ipairs(DEV_IMAGE_PATTERNS) do
                            if img:find(pattern) then
                                return true, plr.Name
                            end
                        end
                    end
                end
            end
        end
        
        local char = plr.Character
        if char then
            local head = char:FindFirstChild("Head")
            if head then
                for _, child in pairs(head:GetChildren()) do
                    if child:IsA("BillboardGui") then
                        for _, desc in pairs(child:GetDescendants()) do
                            if desc:IsA("ImageLabel") or desc:IsA("ImageButton") then
                                local img = desc.Image:lower()
                                for _, pattern in ipairs(DEV_IMAGE_PATTERNS) do
                                    if img:find(pattern) then
                                        return true, plr.Name
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    return false
end

local function serverHop()
    devStatus:SetDesc("üîÑ Server hopping...")
    local success, servers = pcall(function()
        return HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
    end)
    
    if success and servers and servers.data then
        for _, server in pairs(servers.data) do
            if server.id ~= game.JobId and server.playing < server.maxPlayers then
                pcall(function()
                    TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id, player)
                end)
                return
            end
        end
    end
    
    TeleportService:Teleport(game.PlaceId, player)
end

task.spawn(function()
    while task.wait(5) do
        if Fluent.Options.AutoServerHop.Value then
            local devFound, devName = checkForDevelopers()
            if devFound then
                devStatus:SetDesc("‚ö†Ô∏è Dev found: " .. devName .. " - Hopping!")
                task.wait(1)
                serverHop()
                break
            else
                devStatus:SetDesc("‚úÖ No developers detected")
            end
        else
            devStatus:SetDesc("Scanning disabled")
        end
    end
end)

-- Webhook Result Detector (Optimized)
task.spawn(function()
    while task.wait(1) do
        if Fluent.Options.EnableWebhook.Value then
            local Upboard = pGui:FindFirstChild("Upboard")
            local Result = Upboard and Upboard:FindFirstChild("Result")
            
            if Result and Result.Visible then
                task.wait(2.5)
                
                local Main = Result:FindFirstChild("Main")
                if Main then
                    -- Cache all needed references
                    local mapName = Main.MapLabel and Main.MapLabel.Text or "Unknown"
                    local HeaderVictory = Result:FindFirstChild("HeaderVictory")
                    local HeaderDefeated = Result:FindFirstChild("HeaderDefeated")
                    
                    local status, color = "Unknown", 8421504
                    if HeaderVictory and HeaderVictory.Visible then 
                        status, color = "‚úÖ Victory", 65280
                    elseif HeaderDefeated and HeaderDefeated.Visible then 
                        status, color = "‚ùå Defeated", 16711680 
                    end
                    
                    local Statistics = Main:FindFirstChild("Statistics")
                    local Time = Statistics and Statistics:FindFirstChild("Time")
                    local time = Time and Time.CategoryStat and Time.CategoryStat.Text or "N/A"
                    
                    local Rewards = Main:FindFirstChild("Rewards")
                    local rewards = Rewards and Rewards.ScrollingFrame and formatRewards(Rewards.ScrollingFrame) or "No rewards"
                    
                    local success = sendWebhook(Fluent.Options.WebhookURL.Value, {
                        username = "Aden Hub",
                        embeds = {{
                            title = "üéÆ Match Result",
                            color = color,
                            fields = {
                                {name = "üó∫Ô∏è Map", value = mapName, inline = true},
                                {name = "üìä Status", value = status, inline = true},
                                {name = "‚è±Ô∏è Time", value = time, inline = true},
                                {name = "üéÅ Rewards", value = rewards, inline = false}
                            },
                            timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
                        }}
                    })
                    
                    webhookStatus:SetDesc(success and "‚úÖ Sent: " .. os.date("%H:%M:%S") or "‚ùå Failed")
                end
                
                -- Wait for Result to close
                repeat 
                    task.wait(1)
                    Result = Upboard and Upboard:FindFirstChild("Result")
                until not Result or not Result.Visible
            end
        end
    end
end)

-- Wave tracking
WaveValue.Changed:Connect(function(val)
    local num = tonumber(val)
    if num then
        currentWaveNum = num
        aggressiveSpam = Fluent.Options.AutoAwaken.Value and currentWaveNum >= (tonumber(Fluent.Options.StartWaveInput.Value) or 20)
    end
end)

-- Auto Awaken
task.spawn(function()
    while task.wait(0.1) do
        if aggressiveSpam and Fluent.Options.AutoAwaken.Value then
            local lives = workspace:FindFirstChild("Lives")
            if lives then
                for _, unit in ipairs(lives:GetChildren()) do
                    if not Fluent.Options.AutoAwaken.Value then break end
                    pcall(function() ChampionRemote:FireServer("Awaken", unit) end)
                end
            end
        end
    end
end)

-- Auto Retry (Optimized)
task.spawn(function()
    while task.wait(0.5) do
        if Fluent.Options.AutoRetry.Value then
            local Upboard = pGui:FindFirstChild("Upboard")
            local Result = Upboard and Upboard:FindFirstChild("Result")
            
            if Result and Result.Visible then
                task.wait(0.5)
                
                local Main = Result:FindFirstChild("Main")
                local Options = Main and Main:FindFirstChild("Options")
                
                if Options then
                    local PlayAgain = Options:FindFirstChild("PlayAgainButtonHolder")
                    local Leave = Options:FindFirstChild("LeaveButtonHolder")
                    
                    local remoteAction = PlayAgain and "PlayAgain" or (Leave and "Leave")
                    
                    if remoteAction then
                        while Fluent.Options.AutoRetry.Value and Upboard and Upboard.Result and Upboard.Result.Visible do
                            pcall(function() UpboardRemote:FireServer(remoteAction) end)
                            task.wait(1)
                        end
                    end
                end
            end
        end
    end
end)

-- Auto Skip
task.spawn(function()
    while task.wait(4) do
        if Fluent.Options.AutoSkip.Value then
            local Upboard = pGui:FindFirstChild("Upboard")
            if Upboard and Upboard.Wave and Upboard.Wave:FindFirstChild("SkipWaveButtonHolder") then
                pcall(function() UpboardRemote:FireServer("Vote") end)
            end
        end
    end
end)

-- Auto Difficulty
task.spawn(function()
    while task.wait(0.5) do
        if Fluent.Options.AutoDifficulty.Value ~= "None" then
            local PickCard = pGui:FindFirstChild("PickCard")
            if PickCard and PickCard:FindFirstChild("ChristmasCard") and XmasRemote then
                pcall(function() XmasRemote:FireServer("Pick", Fluent.Options.AutoDifficulty.Value) end)
                task.wait(1)
            end
        end
    end
end)

-- IMPROVED: Candy capacity and Bag detection
local currentTestingBagId = nil

-- Listen for Inventory updates (detects successful ticket purchase)
if InventoryRemote then
    InventoryRemote.OnClientEvent:Connect(function(action, itemId, quantity)
        if action == "UpdatePartially" and itemId then
            -- Successfully purchased a ticket! Store its ID
            purchasedTicketId = itemId
            ticketBuyDetected = true
            ticketStatus:SetDesc("‚úÖ Ticket purchased! ID: " .. itemId .. " (Qty: " .. (quantity or 1) .. ")")
        end
    end)
end

NotifyRemote.OnClientEvent:Connect(function(msgType, msgContent)
    if msgType == "Error" and msgContent then
        if msgContent:find("Daily Capacity") then
            candyCapacityReached = true
            dataPara:SetDesc("‚ö†Ô∏è CANDY LIMIT REACHED!")
        elseif msgContent:find("This Item is not usable") or msgContent:find("not usable") then
            -- This bag doesn't work, continue scanning
            if currentTestingBagId then
                bagStatus:SetDesc("‚ö†Ô∏è Bag " .. currentTestingBagId .. " not usable, continuing scan...")
                currentTestingBagId = nil
            end
        end
    elseif msgType == "Prompt" and type(msgContent) == "table" then
        -- Check if this is a bag opening
        if msgContent.RE or msgContent.Dice or msgContent.AbilityShard or msgContent.PMedal or msgContent.DDice then
            if currentTestingBagId and not table.find(activeBagIds, currentTestingBagId) then
                table.insert(activeBagIds, currentTestingBagId)
                bagStatus:SetDesc("‚úÖ Found working bag: " .. currentTestingBagId .. " (Total: " .. #activeBagIds .. ")")
                
                -- Claim the rewards
                task.spawn(function()
                    task.wait(0.1)
                    pcall(function()
                        AwardRemote:FireServer("Prompt", msgContent)
                    end)
                end)
                
                currentTestingBagId = nil
            end
        end
    end
end)

-- Auto Collect (Optimized)
task.spawn(function()
    while task.wait(1) do
        if Fluent.Options.AutoCollect.Value and not isCollectingItems and not candyCapacityReached then
            local char = player.Character
            local hrp = char and char:FindFirstChild("HumanoidRootPart")
            
            if hrp then
                local items = {}
                local candy = Workspace:FindFirstChild("Candy")
                local gift = Workspace:FindFirstChild("Gift")
                
                -- Collect from Candy container
                if candy then
                    for _, item in pairs(candy:GetChildren()) do
                        table.insert(items, {Obj = item, Type = "candy"})
                    end
                end
                
                -- Collect from Gift container
                if gift then
                    for _, item in pairs(gift:GetChildren()) do
                        table.insert(items, {Obj = item, Type = "gift"})
                    end
                end
                
                if #items > 0 then
                    isCollectingItems = true
                    local orig = char:GetPivot()
                    
                    for _, data in ipairs(items) do
                        if not Fluent.Options.AutoCollect.Value or candyCapacityReached then 
                            char:PivotTo(orig)
                            break 
                        end
                        
                        if data.Obj and data.Obj.Parent then
                            char:PivotTo(data.Obj:GetPivot())
                            
                            if data.Type == "candy" then 
                                candyCount = candyCount + 1 
                            else 
                                giftCount = giftCount + 1 
                            end
                            
                            task.wait(0.5)
                        end
                    end
                    
                    if Fluent.Options.AutoCollect.Value and not candyCapacityReached then 
                        char:PivotTo(orig) 
                    end
                    
                    isCollectingItems = false
                end
            end
        end
    end
end)

-- Spin Dodge (Optimized)
RunService.Heartbeat:Connect(function(dt)
    if Fluent.Options.EnableSpin.Value and not isCollectingItems then
        local char = player.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        
        if hrp then
            if not centerPoint then centerPoint = hrp.Position end
            
            local spinSpeed = tonumber(Fluent.Options.SpinSpeed.Value) or 5
            local radius = tonumber(Fluent.Options.SpinRadius.Value) or 10
            
            angle = angle + (spinSpeed * dt * -1)
            
            local cos = math.cos(angle)
            local sin = math.sin(angle)
            
            hrp.CFrame = CFrame.new(
                centerPoint.X + cos * radius, 
                centerPoint.Y + 1, 
                centerPoint.Z + sin * radius
            ) * CFrame.Angles(0, angle, 0)
        end
    else 
        centerPoint = nil 
    end
end)

-- Anti-AFK System
local lastAfkAction = tick()
task.spawn(function()
    while task.wait(1) do
        if Fluent.Options.AntiAFK.Value then
            local timeSinceLastAction = tick() - lastAfkAction
            
            if timeSinceLastAction >= 60 then
                local camera = workspace.CurrentCamera
                if camera then
                    camera.CFrame = camera.CFrame * CFrame.Angles(0, math.rad(0.1), 0)
                end
                
                pcall(function()
                    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.W, false, game)
                    task.wait(0.05)
                    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.W, false, game)
                end)
                
                pcall(function()
                    VirtualInputManager:SendMouseMoveEvent(0, 0, game)
                end)
                
                lastAfkAction = tick()
                afkStatus:SetDesc("Anti-AFK: Active (Last: " .. os.date("%H:%M:%S") .. ")")
            else
                local remaining = 60 - math.floor(timeSinceLastAction)
                afkStatus:SetDesc("Anti-AFK: Next in " .. remaining .. "s")
            end
        else
            afkStatus:SetDesc("Anti-AFK: Disabled")
        end
    end
end)

-- IMPROVED: Use All Bags (Items Tab) - User-Configurable Range Scan
task.spawn(function()
    while task.wait(1) do
        if Fluent.Options.UseAllBags.Value and game.PlaceId == LOBBY_PLACEID and not bagUsageStopped then
            
            -- Phase 1: Initial scanning (only if we don't have 2 working bags yet)
            if #activeBagIds < 2 and not bagCheckInProgress and not scanningComplete then
                bagCheckInProgress = true
                
                -- Get user-defined scan range
                local scanStart = tonumber(Fluent.Options.BagScanStart.Value) or 120
                local scanEnd = tonumber(Fluent.Options.BagScanEnd.Value) or 150
                
                bagStatus:SetDesc("üîç Scanning bags " .. scanStart .. "-" .. scanEnd .. "...")
                
                -- Scan user-defined range (1 second delay each to prevent crash)
                for id = scanStart, scanEnd do
                    if #activeBagIds >= 2 then 
                        bagStatus:SetDesc("‚úÖ Found 2 working bags!")
                        break 
                    end
                    
                    if not table.find(activeBagIds, id) then
                        currentTestingBagId = id
                        pcall(function() 
                            PossessionRemote:FireServer("UseItem_Ten", id) 
                        end)
                        bagStatus:SetDesc("üîç Testing bag ID: " .. id .. " (" .. #activeBagIds .. "/2 found)")
                        task.wait(1) -- CRITICAL: 1 second delay to prevent game crash
                    end
                end
                
                bagCheckInProgress = false
                scanningComplete = true
                
                if #activeBagIds == 0 then
                    bagUsageStopped = true
                    bagStatus:SetDesc("‚ö†Ô∏è No working bags found (" .. scanStart .. "-" .. scanEnd .. ")")
                elseif #activeBagIds == 1 then
                    bagStatus:SetDesc("‚ö†Ô∏è Only found 1 working bag: " .. activeBagIds[1])
                else
                    bagStatus:SetDesc("‚úÖ Found " .. #activeBagIds .. " working bags!")
                end
            end
            
        else
            if bagUsageStopped then
                bagStatus:SetDesc("‚ö†Ô∏è No bags available")
            elseif Fluent.Options.UseAllBags.Value then
                bagStatus:SetDesc("‚ö†Ô∏è Not in lobby")
            else
                bagStatus:SetDesc("Disabled")
            end
        end
    end
end)

-- Separate loop: Use working bags every 4 seconds
task.spawn(function()
    while task.wait(4) do
        if Fluent.Options.UseAllBags.Value and game.PlaceId == LOBBY_PLACEID and #activeBagIds > 0 and not bagUsageStopped then
            -- Use all working bags
            for _, bagId in ipairs(activeBagIds) do
                pcall(function()
                    PossessionRemote:FireServer("UseItem_Ten", bagId)
                end)
                task.wait(0.1) -- Small delay between bags
            end
            
            local bagList = table.concat(activeBagIds, ", ")
            bagStatus:SetDesc("‚úÖ Using bags: " .. bagList .. " (" .. os.date("%H:%M:%S") .. ")")
        end
    end
end)

-- NEW: Auto Buy Ticket System (Improved with Spam Buy)
task.spawn(function()
    while task.wait(0.3) do
        if Fluent.Options.AutoBuyTicket.Value and game.PlaceId == LOBBY_PLACEID and ChristmasShopRemote and not noCurrency then
            -- Reset detection flag before each attempt
            ticketBuyDetected = false
            local attemptStartTime = tick()
            
            -- Spam buy remote 3 times with small delays
            for i = 1, 3 do
                pcall(function()
                    ChristmasShopRemote:FireServer("BuyItem", "Winter Town Ticket")
                end)
                task.wait(0.1)
            end
            
            ticketStatus:SetDesc("üõí Buying ticket... (" .. os.date("%H:%M:%S") .. ")")
            
            -- Wait up to 2 seconds to check if Inventory update was received
            local waitStart = tick()
            while tick() - waitStart < 2 do
                if ticketBuyDetected then
                    -- Successfully purchased!
                    noCurrency = false
                    break
                end
                task.wait(0.1)
            end
            
            -- If still no inventory update after 2 seconds, means no currency
            if not ticketBuyDetected then
                noCurrency = true
                ticketStatus:SetDesc("‚ùå No Currency!")
            else
                -- Reset noCurrency flag on successful purchase
                noCurrency = false
            end
            
        elseif not Fluent.Options.AutoBuyTicket.Value then
            ticketStatus:SetDesc("Disabled")
            noCurrency = false
            ticketBuyDetected = false
        elseif Fluent.Options.AutoBuyTicket.Value and noCurrency then
            ticketStatus:SetDesc("‚ùå No Currency! (Retrying in 5s...)")
            task.wait(5)
            -- Reset and try again after 5 seconds
            noCurrency = false
        elseif Fluent.Options.AutoBuyTicket.Value and game.PlaceId ~= LOBBY_PLACEID then
            ticketStatus:SetDesc("‚ö†Ô∏è Not in lobby")
        end
    end
end)

-- Auto Teleport Timer Monitor
task.spawn(function()
    while task.wait(1) do
        local allTogglesOn = Fluent.Options.AutoJoinChallenge.Value and 
                            Fluent.Options.JoinChristmasEvent.Value and 
                            Fluent.Options.JoinEventNoItem.Value
        
        if allTogglesOn or Fluent.Options.AutoJoinInfinite.Value then
            local currentTime = os.date("*t")
            local hour = currentTime.hour
            local min = currentTime.min
            local sec = currentTime.sec
            local targetWindow = "XX:00 - XX:05"
            
            timeStatus:SetDesc(string.format("Current: %02d:%02d:%02d | Target: %s", hour, min, sec, targetWindow))
            
            if min >= 0 and min <= 5 and game.PlaceId ~= LOBBY_PLACEID then
                local Result = pGui:FindFirstChild("Upboard") and pGui.Upboard:FindFirstChild("Result")
                if Result and Result.Visible then
                    timeStatus:SetDesc(string.format("üö® RETURNING TO LOBBY! (%02d:%02d)", hour, min))
                    
                    local fireStart = tick()
                    while tick() - fireStart < 1 do
                        pcall(function()
                            SettingsRemote:FireServer("ReturnToLobby", Players:WaitForChild("RestartingA_A"))
                        end)
                        task.wait(0.1)
                    end
                    
                    task.wait(2)
                end
            end
        else
            timeStatus:SetDesc("Monitoring disabled (Enable toggles)")
        end
    end
end)

-- Auto Join Challenge & Infinite Mode & Winter Ticket

local function pressE(dur)
    local t = tick()
    while tick() - t < dur do
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
        task.wait(0.05)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
        task.wait(0.05)
    end
end

local function findRoom(item)
    local doors = workspace:FindFirstChild("Doors")
    if not doors then return end
    
    local challenge = doors:FindFirstChild("Challenge")
    if not challenge then return end
    
    for _, roomName in ipairs(CHALLENGE_ROOMS) do
        local room = challenge:FindFirstChild(roomName)
        
        if room then
            local matchDisplay = room:FindFirstChild("MatchDisplayPart")
            if matchDisplay then
                local surfaceGui = matchDisplay:FindFirstChild("SurfaceGui")
                if surfaceGui then
                    local frame = surfaceGui:FindFirstChild("MatchDisplayFrame")
                    if frame then
                        local rewards = frame:FindFirstChild("ChallengeRewards")
                        if rewards then
                            local holder = rewards:FindFirstChild("Holder")
                            if holder and holder:FindFirstChild(item) then
                                return roomName
                            end
                        end
                    end
                end
            end
        end
    end
end

-- NEW: Winter Ticket Function (Uses Purchased Ticket ID)
local function tryWinterTicket()
    if not Fluent.Options.UseWinterTicket.Value then return false end
    
    if not purchasedTicketId then
        winterTicketStatus:SetDesc("‚ùå No purchased ticket ID found! Buy ticket first.")
        return false
    end
    
    winterTicketStatus:SetDesc("üé´ Using purchased ticket ID: " .. purchasedTicketId)
    
    -- Use the purchased ticket
    pcall(function()
        PossessionRemote:FireServer("UseItem", purchasedTicketId)
    end)
    
    task.wait(0.5)
    
    -- Check for success by looking for Winter Event UI
    local checkStart = tick()
    while tick() - checkStart < 2 do
        local lobbyRel = pGui:FindFirstChild("LobbyRelatives")
        if lobbyRel then
            local winterUI = lobbyRel:FindFirstChild("WinterEvent")
            if winterUI then
                local mainFrame = winterUI:FindFirstChild("MainFrame")
                if mainFrame then
                    local contents = mainFrame:FindFirstChild("Contents")
                    if contents then
                        local buttons = contents:FindFirstChild("Buttons")
                        if buttons then
                            local createBtn = buttons:FindFirstChild("Create")
                            if createBtn and createBtn.Visible then
                                winterTicketStatus:SetDesc("‚úÖ Winter ticket " .. purchasedTicketId .. " activated!")
                                
                                task.wait(1)
                                
                                -- Fire Play remote to join the portal
                                local t = tick()
                                while tick() - t < 0.5 do
                                    pcall(function()
                                        DoorsRemote:FireServer("Play", "Custom")
                                    end)
                                    task.wait(0.05)
                                end
                                
                                winterTicketStatus:SetDesc("‚úÖ Joined portal! Waiting for START button...")
                                
                                -- Wait for the game to load and START button to appear
                                task.wait(3)
                                
                                -- Look for and click START button
                                local startClicked = false
                                local startWaitTime = tick()
                                while tick() - startWaitTime < 10 and not startClicked do
                                    local Upboard = pGui:FindFirstChild("Upboard")
                                    if Upboard then
                                        local Wave = Upboard:FindFirstChild("Wave")
                                        if Wave then
                                            local StartButtonHolder = Wave:FindFirstChild("StartButtonHolder")
                                            if StartButtonHolder and StartButtonHolder.Visible then
                                                -- Click START button via remote
                                                pcall(function()
                                                    UpboardRemote:FireServer("Start")
                                                end)
                                                winterTicketStatus:SetDesc("‚úÖ START button clicked!")
                                                startClicked = true
                                                break
                                            end
                                        end
                                    end
                                    task.wait(0.5)
                                end
                                
                                if not startClicked then
                                    winterTicketStatus:SetDesc("‚ö†Ô∏è START button not found, continuing anyway")
                                end
                                
                                return true
                            end
                        end
                    end
                end
            end
        end
        task.wait(0.1)
    end
    
    winterTicketStatus:SetDesc("‚ùå Failed to use ticket ID: " .. purchasedTicketId)
    return false
end

task.spawn(function()
    while task.wait(1) do
        if JoinChallenge.Value and not challengeRunning and DoorsRemote then
            challengeRunning = true
            isInChristmasEvent = false
            isInInfiniteMode = false
            local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if hrp and JoinChallenge.Value then
                hrp.CFrame = CFrame.new(TP_POS)
                task.wait(0.5)
                if not JoinChallenge.Value then challengeRunning = false; continue end
                pressE(0.5)
                task.wait(0.2)
                local item = Fluent.Options.SelectItem.Value
                local room = findRoom(item)
                if room and JoinChallenge.Value then
                    challengeAttempts = 0
                    task.wait(3)
                    if not JoinChallenge.Value then challengeRunning = false; continue end
                    local r = workspace.Doors.Challenge:FindFirstChild(room)
                    if r and r:FindFirstChild("Outsider") then
                        hrp.CFrame = r.Outsider.CFrame
                        task.wait(0.5)
                        if r:FindFirstChild("Teleporter") then
                            local hum = player.Character:FindFirstChild("Humanoid")
                            if hum then hum:MoveTo(r.Teleporter.Position); task.wait(1); hum:Move(Vector3.zero) end
                            local t = tick()
                            while tick() - t < 0.5 and JoinChallenge.Value do
                                pcall(function() DoorsRemote:FireServer("Play", "Challenge") end)
                                task.wait(0.05)
                            end
                            challengeStatus:SetDesc("Joined!")
                            challengeRunning = false
                            task.wait(5)
                            continue
                        end
                    end
                else
                    challengeAttempts = challengeAttempts + 1
                    challengeStatus:SetDesc(string.format("Not found (Attempt %d/3)", challengeAttempts))
                    
                    -- NEW: After 3 failed attempts, use priority system with Winter Ticket
                    if challengeAttempts >= 3 then
                        challengeAttempts = 0
                        challengeStatus:SetDesc("3 attempts failed - Trying priority modes...")
                        
                        local function tryMode(modeName)
                            if modeName == "Winter Ticket" then
                                return tryWinterTicket()
                            elseif modeName == "Infinite Mode" and Fluent.Options.AutoJoinInfinite.Value and LimitlessRemote then
                                isInInfiniteMode = true
                                infiniteStatus:SetDesc("Joining Infinite Mode...")
                                
                                task.wait(2)
                                
                                hrp.CFrame = CFrame.new(INFINITE_POS)
                                task.wait(0.5)
                                
                                local doors = workspace:FindFirstChild("Doors")
                                local limitless = doors and doors:FindFirstChild("Limitless")
                                local limitless08 = limitless and limitless:FindFirstChild("Limitless_08")
                                local teleporter = limitless08 and limitless08:FindFirstChild("Teleporter")
                                
                                if teleporter then
                                    local hum = player.Character:FindFirstChild("Humanoid")
                                    if hum then
                                        hum:MoveTo(teleporter.Position)
                                        task.wait(0.5)
                                        hum:Move(Vector3.zero)
                                    end
                                    
                                    task.wait(0.5)
                                    
                                    local t = tick()
                                    while tick() - t < 0.3 do
                                        pcall(function()
                                            LimitlessRemote:FireServer("Update", "{\"Flag\":\"Limitless\",\"OnlyFriend\":false}")
                                        end)
                                        task.wait(0.05)
                                    end
                                    
                                    t = tick()
                                    while tick() - t < 0.3 do
                                        pcall(function()
                                            DoorsRemote:FireServer("Play", "Limitless")
                                        end)
                                        task.wait(0.05)
                                    end
                                    
                                    infiniteStatus:SetDesc("Infinite Mode joined!")
                                    return true
                                else
                                    infiniteStatus:SetDesc("Teleporter not found")
                                    return false
                                end
                            elseif modeName == "Christmas Event" and Fluent.Options.JoinChristmasEvent.Value and Fluent.Options.JoinEventNoItem.Value and ChristmasMapRemote then
                                isInChristmasEvent = true
                                eventStatus:SetDesc("Joining Christmas Event...")
                                
                                hrp.CFrame = CFrame.new(XMAS_POS)
                                task.wait(4)
                                pressE(0.5)
                                task.wait(0.5)
                                local ui = pGui:FindFirstChild("LobbyRelatives") and pGui.LobbyRelatives:FindFirstChild("WinterEvent") and pGui.LobbyRelatives.WinterEvent:FindFirstChild("MainFrame") and pGui.LobbyRelatives.WinterEvent.MainFrame:FindFirstChild("Contents") and pGui.LobbyRelatives.WinterEvent.MainFrame.Contents:FindFirstChild("Buttons") and pGui.LobbyRelatives.WinterEvent.MainFrame.Contents.Buttons:FindFirstChild("Create")
                                if ui then
                                    local t = tick()
                                    while tick() - t < 0.5 do pcall(function() ChristmasMapRemote:FireServer("Host") end); task.wait(0.05) end
                                    task.wait(0.3)
                                    t = tick()
                                    while tick() - t < 0.5 do pcall(function() DoorsRemote:FireServer("Play", "Custom") end); task.wait(0.05) end
                                    eventStatus:SetDesc("Christmas Event joined!")
                                    return true
                                end
                                return false
                            end
                            return false
                        end
                        
                        -- Try priorities in order
                        local priority1 = Fluent.Options.Priority1.Value
                        local priority2 = Fluent.Options.Priority2.Value
                        local priority3 = Fluent.Options.Priority3.Value
                        
                        local prioritySuccess = false
                        
                        if priority1 ~= "None" then
                            prioritySuccess = tryMode(priority1)
                        end
                        
                        if not prioritySuccess and priority2 ~= "None" then
                            prioritySuccess = tryMode(priority2)
                        end
                        
                        if not prioritySuccess and priority3 ~= "None" then
                            prioritySuccess = tryMode(priority3)
                        end
                        
                        -- If any priority succeeded, wait longer before next challenge attempt
                        if prioritySuccess then
                            challengeStatus:SetDesc("‚úÖ Priority mode joined! Match starting...")
                            
                            -- Wait for match to actually start (player leaves lobby)
                            local waitStart = tick()
                            while game.PlaceId == LOBBY_PLACEID and tick() - waitStart < 30 do
                                task.wait(1)
                            end
                            
                            if game.PlaceId ~= LOBBY_PLACEID then
                                challengeStatus:SetDesc("üéÆ In match... waiting for completion")
                                
                                -- Wait until player returns to lobby (match finished)
                                while game.PlaceId ~= LOBBY_PLACEID do
                                    task.wait(2)
                                end
                                
                                challengeStatus:SetDesc("‚úÖ Match completed! Returned to lobby")
                            else
                                challengeStatus:SetDesc("‚ö†Ô∏è Still in lobby after 30s")
                            end
                            
                            challengeRunning = false
                            task.wait(5) -- Extra 5 seconds before allowing next challenge attempt
                            continue
                        else
                            challengeStatus:SetDesc("‚ùå All priority modes failed")
                        end
                    end
                end
            end
            challengeRunning = false
            task.wait(5)
        end
    end
end)

-- UI Loop (Optimized)
task.spawn(function()
    while task.wait(0.5) do
        -- Update awakening status
        statusPara:SetDesc("Wave: " .. currentWaveNum .. " | Ready: " .. (aggressiveSpam and "YES" or "NO"))
        
        -- Update collection stats
        if not candyCapacityReached then
            dataPara:SetDesc("Gifts: " .. giftCount .. " | Candy: " .. candyCount)
        end
        
        -- Update challenge status
        local joinChallengeActive = JoinChallenge.Value
        if not joinChallengeActive then
            challengeStatus:SetDesc("Auto Join OFF")
            eventStatus:SetDesc("Waiting...")
            winterTicketStatus:SetDesc("Waiting...")
        elseif not DoorsRemote then
            challengeStatus:SetDesc("Not in lobby")
        end
        
        -- Update webhook status
        local webhookEnabled = Fluent.Options.EnableWebhook.Value
        local webhookURL = Fluent.Options.WebhookURL.Value
        local hasURL = webhookURL and webhookURL ~= ""
        
        if webhookEnabled then
            webhookStatus:SetDesc(hasURL and "üü¢ Active" or "‚ö†Ô∏è No URL set")
        else
            webhookStatus:SetDesc(hasURL and "‚ö™ Configured but OFF" or "‚ö™ Not configured")
        end
    end
end)

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)
Window:SelectTab(1)
SaveManager:LoadAutoloadConfig()
