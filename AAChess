local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Services
local RS, Players, WS, RunService, VIM, HttpService, TS = game:GetService("ReplicatedStorage"), game:GetService("Players"), game:GetService("Workspace"), game:GetService("RunService"), game:GetService("VirtualInputManager"), game:GetService("HttpService"), game:GetService("TeleportService")
local player, pGui = Players.LocalPlayer, Players.LocalPlayer:WaitForChild("PlayerGui")

-- Remotes
local ServerInfo = RS:WaitForChild("Server Information")
local Remotes = RS:WaitForChild("Remotes")
local UpboardRemote, ChampionRemote, NotifyRemote, PossessionRemote, SettingsRemote, AwardRemote = Remotes.Upboard, Remotes:WaitForChild("Champion"), Remotes:WaitForChild("Notify"), Remotes:WaitForChild("Possession"), Remotes:WaitForChild("Settings"), Remotes:WaitForChild("Award")
local XmasRemote = Remotes:FindFirstChild("GameModes") and Remotes.GameModes:FindFirstChild("XMasDifficulties")
local InventoryRemote = Remotes:FindFirstChild("Inventory")

local LobbyRel = RS:FindFirstChild("Lobby Relatives")
local DoorsRemote = LobbyRel and LobbyRel:FindFirstChild("Doors")
local ChristmasMapRemote = LobbyRel and LobbyRel:FindFirstChild("ChristmasMap")
local LimitlessRemote = LobbyRel and LobbyRel:FindFirstChild("Limitless")
local ChristmasShopRemote = LobbyRel and LobbyRel:FindFirstChild("ChristmasShop")

-- State
local state = {
    aggressiveSpam = false, currentWave = 0, giftCount = 0, candyCount = 0,
    isCollecting = false, centerPoint = nil, angle = 0,
    challengeRunning = false, challengeAttempts = 0,
    candyCapReached = false, activeBagIds = {}, currentScanId = nil,
    scanningComplete = false, ticketBuyDetected = false, noCurrency = false,
    purchasedTicketId = nil, currentTicketAmount = 0, hasTriedBuyingOnce = false
}

-- Constants
local LOBBY_ID, CHALLENGE_ROOMS = 16695366828, {"Hourly_01_01", "Hourly_01_02", "Hourly_02_01", "Hourly_02_02", "Hourly_03_01", "Hourly_03_02"}
local POS = {TP = Vector3.new(78.55, 4.08, -217.50), XMAS = Vector3.new(-81.45, 3.94, -22.50), INFINITE = Vector3.new(-177.96, 30.14, 41.08), TICKET = Vector3.new(-11.89, 3.10, 259.60)}

-- UI
local Window = Fluent:CreateWindow({Title = "Aden Hub (AAC)", SubTitle = "v138 - Optimized", TabWidth = 140, Size = UDim2.fromOffset(580, 460), Acrylic = false, Theme = "Dark"})
local Tabs = {Main = Window:AddTab({Title = "Main", Icon = "play"}), Ability = Window:AddTab({Title = "Auto Ability", Icon = "zap"}), AutoJoin = Window:AddTab({Title = "Auto Join", Icon = "door-open"}), Dodge = Window:AddTab({Title = "Dodge", Icon = "move"}), Items = Window:AddTab({Title = "Items", Icon = "package"}), Webhook = Window:AddTab({Title = "Webhook", Icon = "send"}), Settings = Window:AddTab({Title = "Settings", Icon = "settings"})}

-- Main Tab
Tabs.Main:AddSection("Statistics")
local dataPara = Tabs.Main:AddParagraph({Title = "Items Collected", Content = "Gifts: 0 | Candy: 0"})
Tabs.Main:AddSection("Automation")
Tabs.Main:AddToggle("AutoCollect", {Title = "Auto Collect", Default = false})
Tabs.Main:AddToggle("AutoRetry", {Title = "Auto Retry Match", Default = false})
Tabs.Main:AddToggle("AutoSkip", {Title = "Auto Skip Waves", Default = false})
Tabs.Main:AddDropdown("AutoDifficulty", {Title = "Difficulty", Values = {"None", "Easy", "Normal", "Hard", "Extreme"}, Default = "None"})

-- Ability Tab
Tabs.Ability:AddSection("Awakening")
Tabs.Ability:AddToggle("AutoAwaken", {Title = "Auto Awaken", Default = false})
Tabs.Ability:AddInput("StartWaveInput", {Title = "Start Wave", Default = "20", Numeric = true})
local statusPara = Tabs.Ability:AddParagraph({Title = "Status", Content = "Wave: 0 | Ready: NO"})

-- Auto Join Tab
Tabs.AutoJoin:AddSection("Challenge Automation")
local JoinChallenge = Tabs.AutoJoin:AddToggle("AutoJoinChallenge", {Title = "Auto Join Challenge", Default = false})
Tabs.AutoJoin:AddDropdown("SelectItem", {Title = "Select Target Item", Values = {"C_A_A_Power Fragment", "C_C_C_Devil Soul", "C_A_A_Deluxe Dice", "C_A_A_Dice"}, Default = "C_A_A_Power Fragment"})
local challengeStatus = Tabs.AutoJoin:AddParagraph({Title = "Challenge Status", Content = "Awaiting Setup..."})

Tabs.AutoJoin:AddSection("Join Christmas Event")
Tabs.AutoJoin:AddToggle("JoinChristmasEvent", {Title = "Join Christmas Event", Default = false})
Tabs.AutoJoin:AddToggle("JoinEventNoItem", {Title = "Join Event if No Item Found", Default = false})
local eventStatus = Tabs.AutoJoin:AddParagraph({Title = "Event Status", Content = "Waiting..."})

Tabs.AutoJoin:AddSection("Auto Join Infinite")
Tabs.AutoJoin:AddToggle("AutoJoinInfinite", {Title = "Auto Join Infinite if No Item", Default = false})
local infiniteStatus = Tabs.AutoJoin:AddParagraph({Title = "Infinite Status", Content = "Waiting..."})

Tabs.AutoJoin:AddSection("Winter Ticket Automation")
Tabs.AutoJoin:AddToggle("UseWinterTicket", {Title = "Auto Use Purchased Winter Ticket", Default = false})
local winterTicketStatus = Tabs.AutoJoin:AddParagraph({Title = "Winter Ticket Status", Content = "Waiting..."})

Tabs.AutoJoin:AddSection("Priority System (After 3 Failed Attempts)")
Tabs.AutoJoin:AddDropdown("Priority1", {Title = "1st Priority", Values = {"None", "Winter Ticket", "Infinite Mode", "Christmas Event"}, Default = "Winter Ticket"})
Tabs.AutoJoin:AddDropdown("Priority2", {Title = "2nd Priority", Values = {"None", "Winter Ticket", "Infinite Mode", "Christmas Event"}, Default = "Infinite Mode"})
Tabs.AutoJoin:AddDropdown("Priority3", {Title = "3rd Priority", Values = {"None", "Winter Ticket", "Infinite Mode", "Christmas Event"}, Default = "Christmas Event"})

Tabs.AutoJoin:AddSection("Auto Teleport Timer")
local timeStatus = Tabs.AutoJoin:AddParagraph({Title = "Time Status", Content = "Monitoring disabled"})

Tabs.AutoJoin:AddSection("Developer Detection")
Tabs.AutoJoin:AddToggle("AutoServerHop", {Title = "Auto Server Hop if Dev Found", Default = false})
local devStatus = Tabs.AutoJoin:AddParagraph({Title = "Dev Status", Content = "Scanning disabled"})

-- Dodge Tab
Tabs.Dodge:AddSection("Spin Dodge")
Tabs.Dodge:AddToggle("EnableSpin", {Title = "Spin Dodge", Default = false})
Tabs.Dodge:AddInput("SpinRadius", {Title = "Radius", Default = "10", Numeric = true})
Tabs.Dodge:AddInput("SpinSpeed", {Title = "Speed", Default = "5", Numeric = true})
Tabs.Dodge:AddSection("Anti-AFK")
Tabs.Dodge:AddToggle("AntiAFK", {Title = "Anti-AFK", Default = true})
local afkStatus = Tabs.Dodge:AddParagraph({Title = "AFK Status", Content = "Anti-AFK: Enabled"})

-- Items Tab
Tabs.Items:AddSection("Bag Opener")
Tabs.Items:AddToggle("UseAllBags", {Title = "Use All Bags", Default = false})
local bagStatus = Tabs.Items:AddParagraph({Title = "Bag Status", Content = "Disabled"})
Tabs.Items:AddSection("Ticket Buyer (Buy with Currency)")
Tabs.Items:AddToggle("AutoBuyTicket", {Title = "Auto Buy Ticket", Default = false})
Tabs.Items:AddInput("MaxTicketAmount", {Title = "Max Ticket Amount", Default = "25", Numeric = true, Placeholder = "Max tickets"})
local ticketStatus = Tabs.Items:AddParagraph({Title = "Ticket Status", Content = "Disabled"})

-- Webhook Tab
Tabs.Webhook:AddSection("Discord Webhook")
Tabs.Webhook:AddInput("WebhookURL", {Title = "Enter Webhook", Default = ""})
Tabs.Webhook:AddToggle("EnableWebhook", {Title = "Enable Webhook", Default = false})
local webhookStatus = Tabs.Webhook:AddParagraph({Title = "Status", Content = "Webhook not configured"})

-- Helper Functions
local function sendWebhook(url, data)
    local s, r = pcall(function()
        local h = syn and syn.request or http and http.request or http_request or request
        return h and h({Url = url, Method = "POST", Headers = {["Content-Type"] = "application/json"}, Body = HttpService:JSONEncode(data)})
    end)
    return s and r and (not r.StatusCode or (r.StatusCode >= 200 and r.StatusCode < 300))
end

local function formatRewards(sf)
    local r = {}
    for _, c in pairs(sf:GetChildren()) do
        if c:IsA("GuiObject") and not c:IsA("UIListLayout") and not c:IsA("UIPadding") and not c:IsA("UIGridLayout") and c.Name:match("^B_") then
            local n = c.Name:gsub("^B_[A-Z]_[A-Z]_", ""):gsub("_", " ")
            if n ~= "" then table.insert(r, "‚Ä¢ " .. n) end
        end
    end
    return #r > 0 and table.concat(r, "\n") or "No rewards"
end

Tabs.Webhook:AddButton({Title = "Test Webhook", Description = "Send test message", Callback = function()
    local url = Fluent.Options.WebhookURL.Value
    if not url or url == "" then webhookStatus:SetDesc("‚ùå Enter webhook URL"); return end
    if not url:match("^https://discord") then webhookStatus:SetDesc("‚ùå Invalid URL"); return end
    webhookStatus:SetDesc("‚è≥ Sending...")
    local s = sendWebhook(url, {username = "Aden Hub", embeds = {{title = "‚úÖ Webhook Test", description = "Working correctly!", color = 65280, timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")}}})
    task.wait(0.5)
    webhookStatus:SetDesc(s and "‚úÖ Test sent!" or "‚ùå Failed")
end})

-- Dev Detection
task.spawn(function()
    while task.wait(5) do
        if Fluent.Options.AutoServerHop.Value then
            local found = false
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= player then
                    local pg = p:FindFirstChild("PlayerGui")
                    if pg then
                        for _, d in pairs((pg:FindFirstChild("OverheadGui") or pg:FindFirstChild("Overhead") or pg:FindFirstChild("DeveloperGui") or {GetDescendants = function() return {} end}):GetDescendants()) do
                            if (d:IsA("ImageLabel") or d:IsA("ImageButton")) and (d.Image:lower():find("hammer") or d.Image:lower():find("admin") or d.Image:lower():find("developer")) then found, devName = true, p.Name break end
                        end
                    end
                    if not found and p.Character and p.Character:FindFirstChild("Head") then
                        for _, c in pairs(p.Character.Head:GetChildren()) do
                            if c:IsA("BillboardGui") then
                                for _, d in pairs(c:GetDescendants()) do
                                    if (d:IsA("ImageLabel") or d:IsA("ImageButton")) and (d.Image:lower():find("hammer") or d.Image:lower():find("admin") or d.Image:lower():find("developer")) then found, devName = true, p.Name break end
                                end
                            end
                        end
                    end
                end
                if found then break end
            end
            if found then
                devStatus:SetDesc("‚ö†Ô∏è Dev found: " .. devName .. " - Hopping!")
                task.wait(1)
                local s, srv = pcall(function() return HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100")) end)
                if s and srv and srv.data then for _, sv in pairs(srv.data) do if sv.id ~= game.JobId and sv.playing < sv.maxPlayers then pcall(function() TS:TeleportToPlaceInstance(game.PlaceId, sv.id, player) end) return end end end
                TS:Teleport(game.PlaceId, player)
                break
            else devStatus:SetDesc("‚úÖ No developers detected") end
        else devStatus:SetDesc("Scanning disabled") end
    end
end)

-- Webhook Result
task.spawn(function()
    while task.wait(1) do
        if Fluent.Options.EnableWebhook.Value then
            local Upboard, Result = pGui:FindFirstChild("Upboard"), nil
            Result = Upboard and Upboard:FindFirstChild("Result")
            if Result and Result.Visible then
                task.wait(2.5)
                local Main = Result:FindFirstChild("Main")
                if Main then
                    local map = Main.MapLabel and Main.MapLabel.Text or "Unknown"
                    local hv, hd = Result:FindFirstChild("HeaderVictory"), Result:FindFirstChild("HeaderDefeated")
                    local status, color = "Unknown", 8421504
                    if hv and hv.Visible then status, color = "‚úÖ Victory", 65280 elseif hd and hd.Visible then status, color = "‚ùå Defeated", 16711680 end
                    local Stats = Main:FindFirstChild("Statistics")
                    local Time = Stats and Stats:FindFirstChild("Time")
                    local time = Time and Time.CategoryStat and Time.CategoryStat.Text or "N/A"
                    local Rewards = Main:FindFirstChild("Rewards")
                    local rewards = Rewards and Rewards.ScrollingFrame and formatRewards(Rewards.ScrollingFrame) or "No rewards"
                    local s = sendWebhook(Fluent.Options.WebhookURL.Value, {username = "Aden Hub", embeds = {{title = "üéÆ Match Result", color = color, fields = {{name = "üó∫Ô∏è Map", value = map, inline = true}, {name = "üìä Status", value = status, inline = true}, {name = "‚è±Ô∏è Time", value = time, inline = true}, {name = "üéÅ Rewards", value = rewards, inline = false}}, timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")}}})
                    webhookStatus:SetDesc(s and "‚úÖ Sent: " .. os.date("%H:%M:%S") or "‚ùå Failed")
                end
                repeat task.wait(1); Result = Upboard and Upboard:FindFirstChild("Result") until not Result or not Result.Visible
            end
        end
    end
end)

-- Wave Tracking & Awaken
ServerInfo:WaitForChild("Wave").Changed:Connect(function(v) local n = tonumber(v); if n then state.currentWave = n; state.aggressiveSpam = Fluent.Options.AutoAwaken.Value and n >= (tonumber(Fluent.Options.StartWaveInput.Value) or 20) end end)
task.spawn(function() while task.wait(0.1) do if state.aggressiveSpam and Fluent.Options.AutoAwaken.Value then local lives = WS:FindFirstChild("Lives"); if lives then for _, u in ipairs(lives:GetChildren()) do if not Fluent.Options.AutoAwaken.Value then break end; pcall(function() ChampionRemote:FireServer("Awaken", u) end) end end end end end)

-- Auto Retry
task.spawn(function()
    while task.wait(0.5) do
        if Fluent.Options.AutoRetry.Value then
            local Upboard, Result = pGui:FindFirstChild("Upboard"), nil
            Result = Upboard and Upboard:FindFirstChild("Result")
            if Result and Result.Visible then
                task.wait(0.5)
                local Main, Options = Result:FindFirstChild("Main"), nil
                Options = Main and Main:FindFirstChild("Options")
                if Options then
                    local ra = (Options:FindFirstChild("PlayAgainButtonHolder") and "PlayAgain") or (Options:FindFirstChild("LeaveButtonHolder") and "Leave")
                    if ra then while Fluent.Options.AutoRetry.Value and Upboard and Upboard.Result and Upboard.Result.Visible do pcall(function() UpboardRemote:FireServer(ra) end); task.wait(1) end end
                end
            end
        end
    end
end)

-- Auto Skip & Difficulty
task.spawn(function() while task.wait(4) do if Fluent.Options.AutoSkip.Value then local Upboard = pGui:FindFirstChild("Upboard"); if Upboard and Upboard.Wave and Upboard.Wave:FindFirstChild("SkipWaveButtonHolder") then pcall(function() UpboardRemote:FireServer("Vote") end) end end end end)
task.spawn(function() while task.wait(0.5) do if Fluent.Options.AutoDifficulty.Value ~= "None" then local PickCard = pGui:FindFirstChild("PickCard"); if PickCard and PickCard:FindFirstChild("ChristmasCard") and XmasRemote then pcall(function() XmasRemote:FireServer("Pick", Fluent.Options.AutoDifficulty.Value) end); task.wait(1) end end end end)

-- Inventory Updates
if InventoryRemote then
    InventoryRemote.OnClientEvent:Connect(function(a, id, qty)
        if a == "UpdatePartially" and id and qty then
            if state.currentScanId and id == state.currentScanId and qty >= 1 then
                if not table.find(state.activeBagIds, id) and #state.activeBagIds < 2 then
                    table.insert(state.activeBagIds, id)
                    bagStatus:SetDesc("‚úÖ Found bag ID: " .. id .. " (Qty: " .. qty .. ") - Total: " .. #state.activeBagIds .. "/2")
                    if #state.activeBagIds >= 2 then state.scanningComplete = true; bagStatus:SetDesc("‚úÖ Scan complete! Found bags: " .. table.concat(state.activeBagIds, ", ")) end
                end
                state.currentScanId = nil
            elseif state.purchasedTicketId == id or (id >= 100 and id <= 119 and qty >= 1) then
                state.purchasedTicketId, state.currentTicketAmount, state.ticketBuyDetected = id, qty, true
                local max = tonumber(Fluent.Options.MaxTicketAmount.Value) or 25
                ticketStatus:SetDesc(state.currentTicketAmount >= max and "‚úÖ MAX REACHED! ID: " .. id .. " (Qty: " .. qty .. "/" .. max .. ")" or "‚úÖ Ticket bought! ID: " .. id .. " (Qty: " .. qty .. "/" .. max .. ")")
            end
        end
    end)
end

NotifyRemote.OnClientEvent:Connect(function(t, c)
    if t == "Error" and c and c:find("Daily Capacity") then state.candyCapReached = true; dataPara:SetDesc("‚ö†Ô∏è CANDY LIMIT REACHED!")
    elseif t == "Prompt" and type(c) == "table" and (c.RE or c.Dice or c.AbilityShard or c.PMedal or c.DDice) then task.spawn(function() task.wait(0.1); pcall(function() AwardRemote:FireServer("Prompt", c) end) end) end
end)

-- Auto Collect
task.spawn(function()
    while task.wait(1) do
        if Fluent.Options.AutoCollect.Value and not state.isCollecting and not state.candyCapReached then
            local char, hrp = player.Character, nil
            hrp = char and char:FindFirstChild("HumanoidRootPart")
            if hrp then
                local items = {}
                local candy, gift = WS:FindFirstChild("Candy"), WS:FindFirstChild("Gift")
                if candy then for _, i in pairs(candy:GetChildren()) do table.insert(items, {Obj = i, Type = "candy"}) end end
                if gift then for _, i in pairs(gift:GetChildren()) do table.insert(items, {Obj = i, Type = "gift"}) end end
                if #items > 0 then
                    state.isCollecting = true
                    local orig = char:GetPivot()
                    for _, d in ipairs(items) do
                        if not Fluent.Options.AutoCollect.Value or state.candyCapReached then char:PivotTo(orig); break end
                        if d.Obj and d.Obj.Parent then
                            char:PivotTo(d.Obj:GetPivot())
                            if d.Type == "candy" then state.candyCount = state.candyCount + 1 else state.giftCount = state.giftCount + 1 end
                            task.wait(0.5)
                        end
                    end
                    if Fluent.Options.AutoCollect.Value and not state.candyCapReached then char:PivotTo(orig) end
                    state.isCollecting = false
                end
            end
        end
    end
end)

-- Spin Dodge
RunService.Heartbeat:Connect(function(dt)
    if Fluent.Options.EnableSpin.Value and not state.isCollecting then
        local char, hrp = player.Character, nil
        hrp = char and char:FindFirstChild("HumanoidRootPart")
        if hrp then
            if not state.centerPoint then state.centerPoint = hrp.Position end
            local spd, rad = tonumber(Fluent.Options.SpinSpeed.Value) or 5, tonumber(Fluent.Options.SpinRadius.Value) or 10
            state.angle = state.angle + (spd * dt * -1)
            hrp.CFrame = CFrame.new(state.centerPoint.X + math.cos(state.angle) * rad, state.centerPoint.Y + 1, state.centerPoint.Z + math.sin(state.angle) * rad) * CFrame.Angles(0, state.angle, 0)
        end
    else state.centerPoint = nil end
end)

-- Anti-AFK
local lastAfk = tick()
task.spawn(function()
    while task.wait(1) do
        if Fluent.Options.AntiAFK.Value then
            local elapsed = tick() - lastAfk
            if elapsed >= 60 then
                local cam = WS.CurrentCamera
                if cam then cam.CFrame = cam.CFrame * CFrame.Angles(0, math.rad(0.1), 0) end
                pcall(function() VIM:SendKeyEvent(true, Enum.KeyCode.W, false, game); task.wait(0.05); VIM:SendKeyEvent(false, Enum.KeyCode.W, false, game) end)
                pcall(function() VIM:SendMouseMoveEvent(0, 0, game) end)
                lastAfk = tick()
                afkStatus:SetDesc("Anti-AFK: Active (Last: " .. os.date("%H:%M:%S") .. ")")
            else afkStatus:SetDesc("Anti-AFK: Next in " .. (60 - math.floor(elapsed)) .. "s") end
        else afkStatus:SetDesc("Anti-AFK: Disabled") end
    end
end)

-- Bag Scanner & User
task.spawn(function()
    while task.wait(1) do
        if Fluent.Options.UseAllBags.Value and game.PlaceId == LOBBY_ID and not state.bagCheckInProgress and #state.activeBagIds < 2 and not state.scanningComplete then
            state.bagCheckInProgress = true
            bagStatus:SetDesc("üîç Starting bag scan (120-150)...")
            for id = 120, 150 do
                if not Fluent.Options.UseAllBags.Value or #state.activeBagIds >= 2 then break end
                state.currentScanId = id
                bagStatus:SetDesc("üîç Testing ID: " .. id .. " (" .. #state.activeBagIds .. "/2 found)")
                for i = 1, 2 do pcall(function() PossessionRemote:FireServer("UseItem", id) end); task.wait(0.1) end
                task.wait(0.5)
            end
            state.bagCheckInProgress = false
            if #state.activeBagIds >= 2 then state.scanningComplete = true; bagStatus:SetDesc("‚úÖ Scan complete! Found bags: " .. table.concat(state.activeBagIds, ", "))
            elseif #state.activeBagIds == 1 then bagStatus:SetDesc("‚ö†Ô∏è Only found 1 bag: " .. state.activeBagIds[1] .. ". Retrying in 5s..."); task.wait(5)
            else bagStatus:SetDesc("‚ùå No bags found in range 120-150. Retrying in 10s..."); task.wait(10) end
        end
    end
end)

task.spawn(function()
    while task.wait(2) do
        if Fluent.Options.UseAllBags.Value and game.PlaceId == LOBBY_ID and #state.activeBagIds > 0 and state.scanningComplete then
            for _, id in ipairs(state.activeBagIds) do pcall(function() PossessionRemote:FireServer("UseItem_Ten", id) end); task.wait(0.1) end
            bagStatus:SetDesc("‚úÖ Using bags: " .. table.concat(state.activeBagIds, ", ") .. " (" .. os.date("%H:%M:%S") .. ")")
        elseif Fluent.Options.UseAllBags.Value and game.PlaceId == LOBBY_ID and #state.activeBagIds == 0 then bagStatus:SetDesc("üîç Scanning for bags...")
        elseif Fluent.Options.UseAllBags.Value and game.PlaceId ~= LOBBY_ID then bagStatus:SetDesc("‚ö†Ô∏è Not in lobby")
        elseif not Fluent.Options.UseAllBags.Value then bagStatus:SetDesc("Disabled"); state.scanningComplete, state.bagCheckInProgress = false, false end
    end
end)

-- Auto Buy Ticket
task.spawn(function()
    while true do
        task.wait(0.1)
        
        -- Check if toggle is enabled first
        if not Fluent.Options.AutoBuyTicket.Value then 
            ticketStatus:SetDesc("Disabled")
            state.noCurrency, state.ticketBuyDetected, state.hasTriedBuyingOnce = false, false, false
            task.wait(1)
            continue
        end
        
        -- Check if in lobby
        if game.PlaceId ~= LOBBY_ID then 
            ticketStatus:SetDesc("‚ö†Ô∏è Not in lobby")
            task.wait(1)
            continue
        end
        
        -- Check if remote exists
        if not ChristmasShopRemote then 
            ticketStatus:SetDesc("‚ö†Ô∏è Shop remote not found")
            task.wait(1)
            continue
        end
        
        local max = tonumber(Fluent.Options.MaxTicketAmount.Value) or 25
        
        -- Check if we've reached max (ONLY if we have ticket ID)
        if state.purchasedTicketId and state.currentTicketAmount >= max then
            ticketStatus:SetDesc("‚úÖ STOPPED! ID: " .. state.purchasedTicketId .. " | Qty: " .. state.currentTicketAmount .. "/" .. max)
            task.wait(2)
            continue
        end
        
        -- BEFORE 3 ATTEMPTS: Buy ONCE
        if state.challengeAttempts < 3 then
            if not state.hasTriedBuyingOnce then
                -- Attempt to buy once
                ticketStatus:SetDesc("üõí Buying ONCE (detecting ID)... Attempt: " .. os.date("%H:%M:%S"))
                state.ticketBuyDetected = false
                
                -- Fire buy remote multiple times for reliability
                for i = 1, 5 do 
                    pcall(function() 
                        ChristmasShopRemote:FireServer("BuyItem", "Winter Town Ticket") 
                    end)
                    task.wait(0.15)
                end
                
                -- Wait for inventory response (up to 4 seconds)
                local waitStart = tick()
                while tick() - waitStart < 4 do
                    if state.ticketBuyDetected then
                        state.noCurrency = false
                        state.hasTriedBuyingOnce = true
                        
                        if state.purchasedTicketId and state.currentTicketAmount then
                            ticketStatus:SetDesc("‚úÖ Detected! ID: " .. state.purchasedTicketId .. " | Qty: " .. state.currentTicketAmount .. "/" .. max)
                            
                            -- Check if already at max
                            if state.currentTicketAmount >= max then 
                                ticketStatus:SetDesc("‚úÖ STOPPED! Already at max: " .. state.currentTicketAmount .. "/" .. max) 
                            end
                        end
                        break
                    end
                    task.wait(0.1)
                end
                
                -- If no response, mark as no currency (but don't block - might just be slow)
                if not state.ticketBuyDetected then
                    ticketStatus:SetDesc("‚ö†Ô∏è No response from buy attempt (may retry)")
                    -- Don't set noCurrency = true immediately, give it another chance
                end
                
                task.wait(3)
            else
                -- Already bought once, just waiting
                ticketStatus:SetDesc("‚è∏Ô∏è Waiting (ID: " .. (state.purchasedTicketId or "Detecting...") .. " | Qty: " .. state.currentTicketAmount .. "/" .. max .. ")")
                task.wait(1)
            end
        else
            -- AFTER 3 ATTEMPTS: Buy every 0.4s
            state.hasTriedBuyingOnce = false -- Reset for next cycle
            
            -- Final check before fast buying
            if state.purchasedTicketId and state.currentTicketAmount >= max then 
                ticketStatus:SetDesc("‚úÖ STOPPED! ID: " .. state.purchasedTicketId .. " | Qty: " .. state.currentTicketAmount .. "/" .. max)
                task.wait(1)
                continue
            end
            
            ticketStatus:SetDesc("üõí FAST BUY [0.4s] (ID: " .. (state.purchasedTicketId or "?") .. " | " .. state.currentTicketAmount .. "/" .. max .. ")")
            state.ticketBuyDetected = false
            
            -- Fire buy remote
            for i = 1, 5 do 
                pcall(function() 
                    ChristmasShopRemote:FireServer("BuyItem", "Winter Town Ticket") 
                end)
                task.wait(0.1)
            end
            
            -- Wait for response
            local waitStart = tick()
            while tick() - waitStart < 2 do
                if state.ticketBuyDetected then
                    state.noCurrency = false
                    
                    if state.purchasedTicketId and state.currentTicketAmount >= max then 
                        ticketStatus:SetDesc("‚úÖ STOPPED! ID: " .. state.purchasedTicketId .. " | Qty: " .. state.currentTicketAmount .. "/" .. max)
                        break
                    else 
                        ticketStatus:SetDesc("‚úÖ Bought! ID: " .. (state.purchasedTicketId or "?") .. " | " .. state.currentTicketAmount .. "/" .. max) 
                    end
                    break
                end
                task.wait(0.1)
            end
            
            -- Check if max reached one more time
            if state.purchasedTicketId and state.currentTicketAmount >= max then 
                ticketStatus:SetDesc("‚úÖ STOPPED! ID: " .. state.purchasedTicketId .. " | Qty: " .. state.currentTicketAmount .. "/" .. max)
                task.wait(1)
                continue
            end
            
            task.wait(0.4) -- 0.4s interval for fast mode
        end
    end
end)

-- Auto Teleport Timer
task.spawn(function()
    while task.wait(1) do
        local allOn = Fluent.Options.AutoJoinChallenge.Value and Fluent.Options.JoinChristmasEvent.Value and Fluent.Options.JoinEventNoItem.Value
        if allOn or Fluent.Options.AutoJoinInfinite.Value then
            local ct = os.date("*t")
            timeStatus:SetDesc(string.format("Current: %02d:%02d:%02d | Target: XX:00 - XX:05", ct.hour, ct.min, ct.sec))
            if ct.min >= 0 and ct.min <= 5 and game.PlaceId ~= LOBBY_ID then
                local Result = pGui:FindFirstChild("Upboard") and pGui.Upboard:FindFirstChild("Result")
                if Result and Result.Visible then
                    timeStatus:SetDesc(string.format("üö® RETURNING TO LOBBY! (%02d:%02d)", ct.hour, ct.min))
                    local fs = tick()
                    while tick() - fs < 1 do pcall(function() SettingsRemote:FireServer("ReturnToLobby", Players:WaitForChild("RestartingA_A")) end); task.wait(0.1) end
                    task.wait(2)
                end
            end
        else timeStatus:SetDesc("Monitoring disabled (Enable toggles)") end
    end
end)

-- Challenge & Priority System
local function pressE(d) local t = tick(); while tick() - t < d do VIM:SendKeyEvent(true, Enum.KeyCode.E, false, game); task.wait(0.05); VIM:SendKeyEvent(false, Enum.KeyCode.E, false, game); task.wait(0.05) end end

local function findRoom(item)
    local doors = WS:FindFirstChild("Doors")
    if not doors then return end
    local challenge = doors:FindFirstChild("Challenge")
    if not challenge then return end
    for _, rn in ipairs(CHALLENGE_ROOMS) do
        local r = challenge:FindFirstChild(rn)
        if r then
            local md = r:FindFirstChild("MatchDisplayPart")
            if md then
                local sg = md:FindFirstChild("SurfaceGui")
                if sg then
                    local f = sg:FindFirstChild("MatchDisplayFrame")
                    if f then
                        local rw = f:FindFirstChild("ChallengeRewards")
                        if rw then
                            local h = rw:FindFirstChild("Holder")
                            if h and h:FindFirstChild(item) then return rn end
                        end
                    end
                end
            end
        end
    end
end

local function tryWinterTicket()
    if not Fluent.Options.UseWinterTicket.Value then return false end
    winterTicketStatus:SetDesc("üìç Teleporting to ticket area...")
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if hrp then hrp.CFrame = CFrame.new(POS.TICKET); task.wait(1) end
    winterTicketStatus:SetDesc("‚è≥ Waiting 0.5s before using ticket...")
    task.wait(0.5)
    if not state.purchasedTicketId then winterTicketStatus:SetDesc("‚ùå No ticket ID from initial purchase - Moving to Priority 2"); return false end
    winterTicketStatus:SetDesc("üé´ Using ticket ID: " .. state.purchasedTicketId .. " (from initial purchase)")
    pcall(function() PossessionRemote:FireServer("UseItem", state.purchasedTicketId) end)
    task.wait(1)
    local cs, uiFound = tick(), false
    while tick() - cs < 3 do
        local lr = pGui:FindFirstChild("LobbyRelatives")
        if lr then
            local wi = lr:FindFirstChild("WinterEvent")
            if wi then
                local mf = wi:FindFirstChild("MainFrame")
                if mf and mf.Visible then
                    local ct = mf:FindFirstChild("Contents")
                    if ct then
                        local bt = ct:FindFirstChild("Buttons")
                        if bt then
                            local cb = bt:FindFirstChild("Create")
                            if cb and cb.Visible then uiFound = true; winterTicketStatus:SetDesc("‚úÖ Winter ticket UI opened!"); break end
                        end
                    end
                end
            end
        end
        task.wait(0.2)
    end
    if not uiFound then winterTicketStatus:SetDesc("‚ùå Ticket UI didn't appear - Moving to Priority 2"); return false end
    task.wait(0.5)
    local t = tick()
    while tick() - t < 1 do pcall(function() DoorsRemote:FireServer("Play", "Custom") end); task.wait(0.1) end
    winterTicketStatus:SetDesc("‚úÖ Joining Winter Event portal...")
    local ws = tick()
    while tick() - ws < 15 do
        if game.PlaceId ~= LOBBY_ID then winterTicketStatus:SetDesc("‚úÖ Successfully joined Winter Event match!"); return true end
        local Upboard = pGui:FindFirstChild("Upboard")
        if Upboard then
            local Wave = Upboard:FindFirstChild("Wave")
            if Wave then
                local sbh = Wave:FindFirstChild("StartButtonHolder")
                if sbh and sbh.Visible then pcall(function() UpboardRemote:FireServer("Start") end); winterTicketStatus:SetDesc("‚úÖ START button clicked! Match starting..."); task.wait(5); return true end
            end
        end
        task.wait(0.5)
    end
    winterTicketStatus:SetDesc("‚ö†Ô∏è Timeout waiting for match start"); return false
end

task.spawn(function()
    while task.wait(1) do
        if JoinChallenge.Value and not state.challengeRunning and DoorsRemote then
            state.challengeRunning = true
            local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if hrp and JoinChallenge.Value then
                hrp.CFrame = CFrame.new(POS.TP); task.wait(0.5)
                if not JoinChallenge.Value then state.challengeRunning = false; continue end
                pressE(0.5); task.wait(0.2)
                local item, room = Fluent.Options.SelectItem.Value, findRoom(Fluent.Options.SelectItem.Value)
                if room and JoinChallenge.Value then
                    state.challengeAttempts = 0; task.wait(3)
                    if not JoinChallenge.Value then state.challengeRunning = false; continue end
                    local r = WS.Doors.Challenge:FindFirstChild(room)
                    if r and r:FindFirstChild("Outsider") then
                        hrp.CFrame = r.Outsider.CFrame; task.wait(0.5)
                        if r:FindFirstChild("Teleporter") then
                            local hum = player.Character:FindFirstChild("Humanoid")
                            if hum then hum:MoveTo(r.Teleporter.Position); task.wait(1); hum:Move(Vector3.zero) end
                            local t = tick()
                            while tick() - t < 0.5 and JoinChallenge.Value do pcall(function() DoorsRemote:FireServer("Play", "Challenge") end); task.wait(0.05) end
                            challengeStatus:SetDesc("Joined!"); state.challengeRunning = false; task.wait(5); continue
                        end
                    end
                else
                    state.challengeAttempts = state.challengeAttempts + 1
                    challengeStatus:SetDesc(string.format("Not found (Attempt %d/3)", state.challengeAttempts))
                    if state.challengeAttempts >= 3 then
                        state.challengeAttempts = 0
                        challengeStatus:SetDesc("3 attempts failed - Trying priority modes...")
                        local function tryMode(m)
                            if m == "Winter Ticket" then return tryWinterTicket()
                            elseif m == "Infinite Mode" and Fluent.Options.AutoJoinInfinite.Value and LimitlessRemote then
                                infiniteStatus:SetDesc("Joining Infinite Mode..."); task.wait(2)
                                hrp.CFrame = CFrame.new(POS.INFINITE); task.wait(0.5)
                                local doors, lim, lim08, tp = WS:FindFirstChild("Doors"), nil, nil, nil
                                lim = doors and doors:FindFirstChild("Limitless")
                                lim08 = lim and lim:FindFirstChild("Limitless_08")
                                tp = lim08 and lim08:FindFirstChild("Teleporter")
                                if tp then
                                    local hum = player.Character:FindFirstChild("Humanoid")
                                    if hum then hum:MoveTo(tp.Position); task.wait(0.5); hum:Move(Vector3.zero) end
                                    task.wait(0.5)
                                    local t = tick()
                                    while tick() - t < 0.3 do pcall(function() LimitlessRemote:FireServer("Update", "{\"Flag\":\"Limitless\",\"OnlyFriend\":false}") end); task.wait(0.05) end
                                    t = tick()
                                    while tick() - t < 0.3 do pcall(function() DoorsRemote:FireServer("Play", "Limitless") end); task.wait(0.05) end
                                    infiniteStatus:SetDesc("Infinite Mode joined!"); return true
                                else infiniteStatus:SetDesc("Teleporter not found"); return false end
                            elseif m == "Christmas Event" and Fluent.Options.JoinChristmasEvent.Value and Fluent.Options.JoinEventNoItem.Value and ChristmasMapRemote then
                                eventStatus:SetDesc("Joining Christmas Event...")
                                hrp.CFrame = CFrame.new(POS.XMAS); task.wait(4); pressE(0.5); task.wait(0.5)
                                local ui = pGui:FindFirstChild("LobbyRelatives") and pGui.LobbyRelatives:FindFirstChild("WinterEvent") and pGui.LobbyRelatives.WinterEvent:FindFirstChild("MainFrame") and pGui.LobbyRelatives.WinterEvent.MainFrame:FindFirstChild("Contents") and pGui.LobbyRelatives.WinterEvent.MainFrame.Contents:FindFirstChild("Buttons") and pGui.LobbyRelatives.WinterEvent.MainFrame.Contents.Buttons:FindFirstChild("Create")
                                if ui then
                                    local t = tick()
                                    while tick() - t < 0.5 do pcall(function() ChristmasMapRemote:FireServer("Host") end); task.wait(0.05) end
                                    task.wait(0.3)
                                    t = tick()
                                    while tick() - t < 0.5 do pcall(function() DoorsRemote:FireServer("Play", "Custom") end); task.wait(0.05) end
                                    eventStatus:SetDesc("Christmas Event joined!"); return true
                                end
                                return false
                            end
                            return false
                        end
                        local p1, p2, p3 = Fluent.Options.Priority1.Value, Fluent.Options.Priority2.Value, Fluent.Options.Priority3.Value
                        local ps = false
                        if p1 ~= "None" then ps = tryMode(p1) end
                        if not ps and p2 ~= "None" then ps = tryMode(p2) end
                        if not ps and p3 ~= "None" then ps = tryMode(p3) end
                        if ps then
                            challengeStatus:SetDesc("‚úÖ Priority mode joined! Match starting...")
                            local ws = tick()
                            while game.PlaceId == LOBBY_ID and tick() - ws < 30 do task.wait(1) end
                            if game.PlaceId ~= LOBBY_ID then
                                challengeStatus:SetDesc("üéÆ In match... waiting for completion")
                                while game.PlaceId ~= LOBBY_ID do task.wait(2) end
                                challengeStatus:SetDesc("‚úÖ Match completed! Returned to lobby")
                            else challengeStatus:SetDesc("‚ö†Ô∏è Still in lobby after 30s") end
                            state.challengeRunning = false; task.wait(5); continue
                        else challengeStatus:SetDesc("‚ùå All priority modes failed") end
                    end
                end
            end
            state.challengeRunning = false; task.wait(5)
        end
    end
end)

-- UI Loop
task.spawn(function()
    while task.wait(0.5) do
        statusPara:SetDesc("Wave: " .. state.currentWave .. " | Ready: " .. (state.aggressiveSpam and "YES" or "NO"))
        if not state.candyCapReached then dataPara:SetDesc("Gifts: " .. state.giftCount .. " | Candy: " .. state.candyCount) end
        if not JoinChallenge.Value then challengeStatus:SetDesc("Auto Join OFF"); eventStatus:SetDesc("Waiting..."); winterTicketStatus:SetDesc("Waiting...")
        elseif not DoorsRemote then challengeStatus:SetDesc("Not in lobby") end
        local we, wu = Fluent.Options.EnableWebhook.Value, Fluent.Options.WebhookURL.Value
        webhookStatus:SetDesc(we and ((wu and wu ~= "") and "üü¢ Active" or "‚ö†Ô∏è No URL set") or ((wu and wu ~= "") and "‚ö™ Configured but OFF" or "‚ö™ Not configured"))
    end
end)

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)
Window:SelectTab(1)
SaveManager:LoadAutoloadConfig()
